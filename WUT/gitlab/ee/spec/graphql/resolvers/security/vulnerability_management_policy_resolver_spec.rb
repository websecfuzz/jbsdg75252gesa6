# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Resolvers::Security::VulnerabilityManagementPolicyResolver, feature_category: :security_policy_management do
  include GraphqlHelpers

  include_context 'orchestration policy context'

  let(:policy) { build(:vulnerability_management_policy, name: 'Run auto resolve') }
  let(:policy_yaml) { build(:orchestration_policy_yaml, vulnerability_management_policy: [policy]) }
  let(:expected_resolved) do
    [
      {
        name: 'Run auto resolve',
        description: 'This policy enforces resolving of no longer detected low SAST vulnerabilities',
        edit_path: Gitlab::Routing.url_helpers.edit_project_security_policy_url(
          project, id: CGI.escape(policy[:name]), type: 'vulnerability_management_policy'
        ),
        enabled: true,
        policy_scope: {
          compliance_frameworks: [],
          including_projects: [],
          excluding_projects: [],
          including_groups: [],
          excluding_groups: []
        },
        yaml: YAML.dump({
          name: policy[:name],
          description: policy[:description],
          enabled: policy[:enabled],
          policy_scope: policy[:policy_scope],
          rules: policy[:rules],
          actions: policy[:actions]
        }.compact.deep_stringify_keys),
        updated_at: policy_last_updated_at,
        source: {
          inherited: false,
          namespace: nil,
          project: project
        }
      }
    ]
  end

  subject(:resolve_policies) { resolve(described_class, obj: project, ctx: { current_user: user }) }

  it_behaves_like 'as an orchestration policy'
end
