# frozen_string_literal: true

RSpec.shared_examples 'it syncs vulnerabilities with elasticsearch' do
  it 'syncs matching vulnerabilities with elasticsearch' do
    bulk_es_service = instance_double(::Vulnerabilities::BulkEsOperationService)

    expect(Vulnerabilities::BulkEsOperationService).to receive(:new) do |relation|
      expect(relation).to be_an(ActiveRecord::Relation)
      expect(relation.pluck(:id)).to match_array(expected_vulnerability_ids)
    end.and_return(bulk_es_service)

    expect(bulk_es_service).to receive(:execute)

    subject
  end
end

RSpec.shared_examples 'does not sync with elasticsearch when no vulnerabilities' do
  it 'does not call elasticsearch sync when no vulnerabilities' do
    expect(Vulnerabilities::BulkEsOperationService).not_to receive(:new)
    subject
  end
end
