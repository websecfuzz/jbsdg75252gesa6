# frozen_string_literal: true

module Search
  module Elastic
    module Preloaders
      module Vulnerability
        # Coordinator class that orchestrates multiple preloaders to create
        # enhanced record proxies for elasticsearch indexing.
        #
        # This class:
        # 1. Coordinates multiple individual preloaders (EPSS, CVE, Reachability)
        # 2. Creates enhanced proxies with all preloaded data
        # 3. Assigns proxies back to reference objects
        # 4. Provides a single entry point for all vulnerability data preloading
        class EnhancedProxy
          def initialize(refs, records)
            @refs = refs
            @records = records
            @records_by_id = Array(records).index_by(&:vulnerability_id)
          end

          # Preload all data and creates enhanced proxies with the refs database_record set to proxy record.
          def preload_and_enhance!
            preload_all_data
            create_and_assign_proxies
          end

          private

          attr_reader :refs, :records_by_id, :records

          # Preload all required data using individual preloaders
          def preload_all_data
            @reachability_data = Reachability.new(records).preload
          end

          # Create enhanced proxies and assign them to references
          def create_and_assign_proxies
            refs.each do |ref|
              record = records_by_id[ref.identifier]
              next unless record

              proxy = create_enhanced_proxy(record)

              ref.database_record = proxy
            end
          end

          # Create an enhanced proxy for a single record
          def create_enhanced_proxy(record)
            vulnerability_id = record.vulnerability_id
            enhancements = {
              'reachability' => fetch_reachability_value(vulnerability_id)
            }.with_indifferent_access

            ::Search::Elastic::RecordProxy::Vulnerability.create_with_enhancements(record, enhancements)
          end

          def fetch_reachability_value(vulnerability_id)
            @reachability_data[vulnerability_id] || ::Enums::Sbom::REACHABILITY_TYPES[::Enums::Sbom::UNKNOWN]
          end
        end
      end
    end
  end
end
