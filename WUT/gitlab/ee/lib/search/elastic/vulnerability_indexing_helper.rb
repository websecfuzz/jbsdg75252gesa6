# frozen_string_literal: true

module Search
  module Elastic
    module VulnerabilityIndexingHelper
      REQUIRED_MIGRATIONS = [
        :create_vulnerabilities_index,
        :revise_vulnerabilities_mappings_and_field_types
      ].freeze

      def self.vulnerability_indexing_allowed?
        @vulnerability_indexing_allowed ||= es_migrations_available? && (sass_with_es? || dedicated_with_es?)
      end

      class << self
        private

        def es_migrations_available?
          REQUIRED_MIGRATIONS.all? do |migration|
            ::Elastic::DataMigrationService.migration_has_finished?(migration)
          end
        end

        def sass_with_es?
          Gitlab::CurrentSettings.elasticsearch_indexing? &&
            Gitlab::Saas.feature_available?(:advanced_search)
        end

        def dedicated_with_es?
          Gitlab::CurrentSettings.elasticsearch_indexing? &&
            Gitlab::CurrentSettings.gitlab_dedicated_instance?
        end
      end
    end
  end
end
