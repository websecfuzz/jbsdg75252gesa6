# frozen_string_literal: true

class VulnerabilityEntity < Grape::Entity
  include RequestAwareEntity

  MAX_SBOM_OCCURRENCES = 500

  expose :id,
    :title,
    :state,
    :severity,
    :report_type,
    :resolved_on_default_branch,
    :project_default_branch,
    :resolved_at,
    :resolved_by_id,
    :dismissed_at,
    :dismissed_by_id,
    :confirmed_at,
    :confirmed_by_id
  expose :state_transitions, using: Vulnerabilities::StateTransitionEntity
  expose :issue_links, using: Vulnerabilities::IssueLinkEntity
  expose :merge_request_links, using: Vulnerabilities::MergeRequestLinkEntity
  expose :created_at, as: :detected_at
  expose :ai_resolution_enabled?, as: :ai_resolution_enabled

  expose :reachability
  expose :sbom_occurrences do |vulnerability|
    vulnerability.sbom_occurrences_with_dependency_paths_data(limit: MAX_SBOM_OCCURRENCES).map do |occurrence|
      {
        id: occurrence.id,
        input_file_path: occurrence.input_file_path,
        has_dependency_paths: occurrence.has_dependency_paths?
      }
    end
  end
end
