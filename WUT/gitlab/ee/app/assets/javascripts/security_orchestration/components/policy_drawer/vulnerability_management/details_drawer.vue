<script>
import { s__ } from '~/locale';
import { humanizeRules } from 'ee/security_orchestration/components/policy_drawer/vulnerability_management/utils';
import { SUMMARY_TITLE } from 'ee/security_orchestration/components/policy_drawer/constants';
import {
  POLICY_TYPE_COMPONENT_OPTIONS,
  VULNERABILITY_MANAGEMENT_POLICY_TYPE_HEADER,
} from 'ee/security_orchestration/components/constants';
import { fromYaml } from 'ee/security_orchestration/components/utils';
import DrawerLayout from '../drawer_layout.vue';
import InfoRow from '../info_row.vue';

export default {
  i18n: {
    vulnerabilityManagementType: VULNERABILITY_MANAGEMENT_POLICY_TYPE_HEADER,
    summary: SUMMARY_TITLE,
    vulnerabilityManagementActionHeader: s__(
      'SecurityOrchestration|Resolve the following vulnerabilities that are no longer detected on the default branch:',
    ),
  },
  components: {
    InfoRow,
    DrawerLayout,
  },
  props: {
    policy: {
      type: Object,
      required: true,
    },
  },
  computed: {
    policyScope() {
      return this.policy?.policyScope;
    },
    parsedYaml() {
      return fromYaml({
        manifest: this.policy.yaml,
        type: POLICY_TYPE_COMPONENT_OPTIONS.vulnerabilityManagement.urlParameter,
      });
    },
    description() {
      return this.parsedYaml?.description || '';
    },
    humanizedRules() {
      return humanizeRules(this.parsedYaml?.rules);
    },
  },
};
</script>

<template>
  <drawer-layout
    key="vulnerability_management_policy"
    :description="description"
    :policy="policy"
    :policy-scope="policyScope"
    :type="$options.i18n.vulnerabilityManagementType"
  >
    <template v-if="parsedYaml" #summary>
      <info-row data-testid="policy-summary" :label="$options.i18n.summary">
        <div data-testid="summary-header">
          {{ $options.i18n.vulnerabilityManagementActionHeader }}
        </div>
        <ul>
          <li
            v-for="rule in humanizedRules"
            :key="rule"
            class="gl-mt-3"
            data-testid="summary-field"
          >
            {{ rule }}
          </li>
        </ul>
      </info-row>
    </template>
  </drawer-layout>
</template>
