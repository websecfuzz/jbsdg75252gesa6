<script>
import { GlCard, GlSkeletonLoader } from '@gitlab/ui';
import SeverityBadge from 'ee/vue_shared/security_reports/components/severity_badge.vue';
import {
  DASHBOARD_TYPE_PROJECT,
  DASHBOARD_TYPE_GROUP,
  DASHBOARD_TYPE_INSTANCE,
} from 'ee/security_dashboard/constants';
import { createAlert } from '~/alert';
import { ERROR_POLICY_NONE } from '~/lib/graphql';
import { s__, sprintf } from '~/locale';
import countsQuery from 'ee/security_dashboard/graphql/queries/vulnerability_severities_count.query.graphql';
import { SEVERITIES, SEVERITY_COUNT_LIMIT } from 'ee/vulnerabilities/constants';

export default {
  components: { GlCard, GlSkeletonLoader, SeverityBadge },
  inject: ['fullPath', 'dashboardType'],
  props: {
    filters: {
      type: Object,
      required: false,
      default: null,
    },
  },
  data() {
    return {
      counts: {},
    };
  },
  apollo: {
    counts: {
      query: countsQuery,
      errorPolicy: ERROR_POLICY_NONE,
      variables() {
        return {
          fullPath: this.fullPath,
          isProject: this.dashboardType === DASHBOARD_TYPE_PROJECT,
          isGroup: this.dashboardType === DASHBOARD_TYPE_GROUP,
          isInstance: this.dashboardType === DASHBOARD_TYPE_INSTANCE,
          capped: true,
          ...this.filters,
        };
      },
      update(data) {
        return data[this.dashboardType].vulnerabilitySeveritiesCount;
      },
      error() {
        createAlert({
          message: s__(
            'SecurityReports|Error fetching the vulnerability counts. Please check your network connection and try again.',
          ),
        });
      },
      skip() {
        return !this.filters;
      },
    },
  },
  computed: {
    isLoadingCounts() {
      return !this.filters || this.$apollo.queries.counts.loading;
    },
    severityCounts() {
      return SEVERITIES.map((severity) => ({
        severity,
        count: this.counts[severity] || 0,
      }));
    },
  },
  watch: {
    severityCounts() {
      this.$emit('counts-changed', this.severityCounts);
    },
  },
  methods: {
    formattedCounts(counts) {
      return counts > SEVERITY_COUNT_LIMIT
        ? sprintf(s__('SecurityReports|%{count}+'), { count: SEVERITY_COUNT_LIMIT })
        : counts;
    },
  },
};
</script>

<template>
  <div class="vulnerability-counts gl-text-center gl-font-bold">
    <gl-card
      v-for="{ severity, count } in severityCounts"
      :key="severity"
      :data-testid="severity"
      header-class="gl-p-3"
      body-class="gl-flex gl-justify-center gl-items-center"
    >
      <template #header>
        <severity-badge :severity="severity" class="!gl-text-center" />
      </template>

      <template #default>
        <gl-skeleton-loader v-if="isLoadingCounts" :equal-width-lines="true" :lines="1" />
        <span v-else class="gl-text-size-h2">{{ formattedCounts(count) }}</span>
      </template>
    </gl-card>
  </div>
</template>
