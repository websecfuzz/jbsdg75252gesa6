<script>
import { GlTabs } from '@gitlab/ui';
import { omit, isEqual } from 'lodash';
import { s__ } from '~/locale';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import { DASHBOARD_TYPE_PROJECT } from 'ee/security_dashboard/constants';
import VulnerabilityReportHeader from './vulnerability_report_header.vue';
import VulnerabilityReportTab from './vulnerability_report_tab.vue';
import ContainerScanningForRegistryTab from './container_scanning_for_registry_tab.vue';
import { FIELD_PRESETS, FILTER_PRESETS, REPORT_TYPE_PRESETS } from './constants';

export const TAB_NAMES = {
  OPERATIONAL: 'OPERATIONAL',
  CONTAINER_REGISTRY: 'CONTAINER_REGISTRY',
};

const TAB_NAME_TO_INDEX = {
  [TAB_NAMES.OPERATIONAL]: 1,
  [TAB_NAMES.CONTAINER_REGISTRY]: 2,
};

const TAB_INDEX_TO_NAME = {
  1: TAB_NAMES.OPERATIONAL,
  2: TAB_NAMES.CONTAINER_REGISTRY,
};

export default {
  components: {
    GlTabs,
    VulnerabilityReportHeader,
    VulnerabilityReportTab,
    ContainerScanningForRegistryTab,
  },
  mixins: [glFeatureFlagsMixin()],
  inject: ['dashboardType'],
  computed: {
    tabIndex: {
      get() {
        return TAB_NAME_TO_INDEX[this.$route.query.tab] ?? 0;
      },
      set(index) {
        // Don't set the tab index if it's the same. This prevents some querystring bugs.
        if (index === this.tabIndex) {
          return;
        }

        const newQuery = {
          ...this.$route.query,
          tab: TAB_INDEX_TO_NAME[index],
        };

        const query = omit(newQuery, ['before', 'after']);

        if (!isEqual(query, this.$route.query)) {
          this.$router.push({ query });
        }
      },
    },
    isProjectReport() {
      return this.dashboardType === DASHBOARD_TYPE_PROJECT;
    },
    filterDropdownsDevelopment() {
      if (this.glFeatures.vulnerabilityReportTypeScannerFilter) {
        if (this.isProjectReport) {
          return FILTER_PRESETS.DEVELOPMENT_PROJECT;
        }
        return FILTER_PRESETS.DEVELOPMENT_LEGACY;
      }
      return this.isProjectReport
        ? FILTER_PRESETS.DEVELOPMENT_PROJECT_LEGACY
        : FILTER_PRESETS.DEVELOPMENT_LEGACY;
    },
    filterDropdownsOperational() {
      if (this.isProjectReport) {
        return FILTER_PRESETS.OPERATIONAL_PROJECT;
      }

      return FILTER_PRESETS.OPERATIONAL;
    },
  },
  methods: {
    transformFiltersDevelopment(filters) {
      // If `reportType` and `scanner` are `undefined` or an empty array
      // we need to use the report type development presets for `reportType`
      // to make sure cluster image scanning vulnerabilities are not included
      // on the development tab.
      if (filters.reportType?.length || filters.scanner?.length) {
        return filters;
      }

      return {
        ...filters,
        reportType: REPORT_TYPE_PRESETS.DEVELOPMENT,
      };
    },
    transformFiltersOperational(filters) {
      return {
        ...filters,
        reportType: REPORT_TYPE_PRESETS.OPERATIONAL,
      };
    },
  },
  i18n: {
    developmentTab: s__('SecurityReports|Development vulnerabilities'),
    operationalTab: s__('SecurityReports|Operational vulnerabilities'),
    operationalTabMessage: s__(
      'SecurityReports|Detected in external sources such as running containers and URLs. These vulnerabilities are not necessarily associated with your GitLab project.',
    ),
  },
  FIELD_PRESETS,
};
</script>

<template>
  <div>
    <vulnerability-report-header />

    <gl-tabs v-model="tabIndex" content-class="gl-pt-0">
      <vulnerability-report-tab
        :title="$options.i18n.developmentTab"
        :fields="
          glFeatures.vulnerabilityReportTypeScannerFilter
            ? $options.FIELD_PRESETS.DEVELOPMENT
            : $options.FIELD_PRESETS.DEVELOPMENT_LEGACY
        "
        :filter-dropdowns="filterDropdownsDevelopment"
        :filter-fn="transformFiltersDevelopment"
        :is-active-tab="tabIndex === 0"
      >
        <template #header>
          <slot name="header-development"></slot>
        </template>
      </vulnerability-report-tab>

      <vulnerability-report-tab
        :title="$options.i18n.operationalTab"
        :fields="$options.FIELD_PRESETS.OPERATIONAL"
        :filter-dropdowns="filterDropdownsOperational"
        :filter-fn="transformFiltersOperational"
        :is-active-tab="tabIndex === 1"
      >
        <template #header>
          <div class="gl-border-b gl-bg-subtle gl-p-5">
            {{ $options.i18n.operationalTabMessage }}
          </div>
        </template>
      </vulnerability-report-tab>

      <container-scanning-for-registry-tab
        v-if="isProjectReport"
        :is-active-tab="tabIndex === 2"
        data-testid="container-scanning-for-registry-tab"
      />
    </gl-tabs>
  </div>
</template>
