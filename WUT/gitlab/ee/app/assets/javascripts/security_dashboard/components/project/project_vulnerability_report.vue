<script>
import { difference } from 'lodash';
import { GlAlert } from '@gitlab/ui';
import { s__ } from '~/locale';
import LocalStorageSync from '~/vue_shared/components/local_storage_sync.vue';
import { translateScannerNames } from '~/security_configuration/utils';
import SecurityTrainingPromoBanner from 'ee/security_dashboard/components/project/security_training_promo_banner.vue';
import VulnerabilityRetentionAlert from '../shared/vulnerability_retention_alert.vue';
import VulnerabilityReportTabs from '../shared/vulnerability_report/vulnerability_report_tabs.vue';
import ProjectPipelineStatus from '../shared/project_pipeline_status.vue';
import securityScannersQuery from '../../graphql/queries/project_security_scanners.query.graphql';
import SecurityScannerAlert from './security_scanner_alert.vue';

const VULNERABILITY_QUOTA = {
  critical: s__(
    'SecurityReports|This project is reaching the maximum number of vulnerabilities it can contain.',
  ),
  full: s__(
    'SecurityReports|This project has reached the maximum number of vulnerabilities it can contain. New vulnerabilities will not be created.',
  ),
  exceeded: s__(
    "SecurityReports|This project has reached the maximum number of vulnerabilities it can contain and some of the vulnerabilities couldn't be ingested.",
  ),
};

export default {
  components: {
    LocalStorageSync,
    SecurityScannerAlert,
    ProjectPipelineStatus,
    VulnerabilityReportTabs,
    SecurityTrainingPromoBanner,
    GlAlert,
    VulnerabilityRetentionAlert,
  },
  inject: [
    'fullPath',
    'pipeline',
    'sbomPipeline',
    'hasVulnerabilities',
    'hideThirdPartyOffers',
    'vulnerabilityQuota',
  ],
  data() {
    return {
      scannerAlertDismissed: false,
      securityScanners: {},
    };
  },
  apollo: {
    securityScanners: {
      query: securityScannersQuery,
      variables() {
        return { fullPath: this.fullPath };
      },
      update({ project = {} }) {
        const { available = [], enabled = [], pipelineRun = [] } = project?.securityScanners || {};

        return {
          available: translateScannerNames(available),
          enabled: translateScannerNames(enabled),
          pipelineRun: translateScannerNames(pipelineRun),
        };
      },
    },
  },
  computed: {
    quotaWarning() {
      return VULNERABILITY_QUOTA[this.vulnerabilityQuota];
    },
    notEnabledSecurityScanners() {
      const { available = [], enabled = [] } = this.securityScanners;
      return difference(available, enabled);
    },
    noPipelineRunSecurityScanners() {
      const { enabled = [], pipelineRun = [] } = this.securityScanners;
      return difference(enabled, pipelineRun);
    },
    shouldShowPipelineStatus() {
      return this.pipeline.createdAt && this.pipeline.id && this.pipeline.path;
    },
    shouldShowScannersAlert() {
      return (
        !this.scannerAlertDismissed &&
        (this.notEnabledSecurityScanners.length > 0 ||
          this.noPipelineRunSecurityScanners.length > 0)
      );
    },
    shouldShowPromoBanner() {
      return !this.hideThirdPartyOffers;
    },
  },
  methods: {
    dismissScannerAlert() {
      this.scannerAlertDismissed = true;
    },
  },
  SCANNER_ALERT_DISMISSED_LOCAL_STORAGE_KEY: 'vulnerability_list_scanner_alert_dismissed',
};
</script>

<template>
  <div>
    <local-storage-sync
      v-model="scannerAlertDismissed"
      :storage-key="$options.SCANNER_ALERT_DISMISSED_LOCAL_STORAGE_KEY"
    />
    <security-scanner-alert
      v-if="shouldShowScannersAlert"
      :not-enabled-scanners="notEnabledSecurityScanners"
      :no-pipeline-run-scanners="noPipelineRunSecurityScanners"
      @dismiss="dismissScannerAlert"
    />

    <gl-alert
      v-if="quotaWarning"
      title="Warning"
      variant="warning"
      class="gl-mt-5"
      :dismissible="false"
    >
      {{ quotaWarning }}
    </gl-alert>

    <vulnerability-retention-alert />

    <security-training-promo-banner v-if="shouldShowPromoBanner" class="gl-mt-5" />

    <vulnerability-report-tabs>
      <template #header-development>
        <project-pipeline-status
          v-if="shouldShowPipelineStatus"
          :pipeline="pipeline"
          :sbom-pipeline="sbomPipeline"
        />
      </template>
    </vulnerability-report-tabs>
  </div>
</template>
