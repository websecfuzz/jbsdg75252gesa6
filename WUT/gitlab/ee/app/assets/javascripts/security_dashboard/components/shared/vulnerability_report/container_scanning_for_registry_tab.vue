<script>
import { GlCard, GlAlert, GlSprintf, GlLink, GlLoadingIcon, GlEmptyState } from '@gitlab/ui';
import secureEmptyStateSvg from '@gitlab/svgs/dist/illustrations/empty-state/empty-secure-md.svg';
import { s__, __ } from '~/locale';
import getProjectContainerScanning from 'ee/packages_and_registries/container_registry/explorer/graphql/queries/get_project_container_scanning.query.graphql';
import { helpPagePath } from '~/helpers/help_page_helper';
import VulnerabilityReportTab from './vulnerability_report_tab.vue';

import { FIELD_PRESETS, FILTER_PRESETS, REPORT_TYPE_PRESETS } from './constants';

export const CONTAINER_SCANNING_FOR_REGISTRY_ALERT_DISMISSED =
  'container_scanning_for_registry_alert_dismissed';

export const DOC_PATH_CONTAINER_SCANNING_FOR_REGISTRY = helpPagePath(
  'user/application_security/container_scanning/_index',
  { anchor: 'container-scanning-for-registry' },
);

export const DOC_PATH_CONTAINER_REGISTRY = helpPagePath('user/packages/container_registry/_index');

export default {
  components: {
    GlCard,
    GlAlert,
    GlSprintf,
    GlLink,
    GlLoadingIcon,
    GlEmptyState,
    VulnerabilityReportTab,
  },
  inject: ['fullPath', 'securityConfigurationPath'],
  props: {
    isActiveTab: {
      type: Boolean,
      required: true,
    },
  },
  apollo: {
    // eslint-disable-next-line @gitlab/vue-no-undef-apollo-properties
    containerScanningData: {
      query: getProjectContainerScanning,
      variables() {
        return {
          fullPath: this.fullPath,
          securityConfigurationPath: this.securityConfigurationPath,
        };
      },
      update(data) {
        return data.project.containerScanningForRegistry ?? { isEnabled: false, isVisible: false };
      },
    },
  },
  i18n: {
    bannerTitle: s__('SecurityReports|Container Scanning for registry is active'),
    containerRegistryTab: s__('SecurityReports|Container registry vulnerabilities'),
    containerRegistryTabMessage: s__(
      'SecurityReports|Container scanning for registry scans the latest tag of each image. It scans for vulnerabilities in the container registry when an image or database is updated.',
    ),
    emptyStateTitle: s__('SecurityReports|Container scanning for registry is not enabled'),
    emptyStateDescription: s__(
      'SecurityReports|Container Scanning for Registry scans the latest tag of each image for vulnerabilities. %{linkStart}How do I enable Container Scanning for Registry?%{linkEnd}',
    ),
    cvsMessage: s__(
      'SecurityReports|Container Scanning for Registry scans the latest tag of each image. It scans for vulnerabilities in the container %{linkStart}registry%{linkEnd} when an image or database is updated.',
    ),
    learnMore: __('Learn more'),
    dismiss: __('Dismiss'),
  },
  data() {
    return {
      isAlertDismissed:
        localStorage.getItem(CONTAINER_SCANNING_FOR_REGISTRY_ALERT_DISMISSED) === 'true',
    };
  },
  computed: {
    hasContainerScanningForRegistryConfigured() {
      return this.containerScanningData?.isEnabled;
    },
  },
  methods: {
    transformFiltersContainerRegistry(filters) {
      return {
        ...filters,
        reportType: REPORT_TYPE_PRESETS.CONTAINER_REGISTRY,
      };
    },
    dismissAlert() {
      this.isAlertDismissed = true;
      localStorage.setItem(CONTAINER_SCANNING_FOR_REGISTRY_ALERT_DISMISSED, 'true');
    },
  },
  DOC_PATH_CONTAINER_SCANNING_FOR_REGISTRY,
  DOC_PATH_CONTAINER_REGISTRY,
  FIELD_PRESETS,
  FILTER_PRESETS,
  secureEmptyStateSvg,
};
</script>

<template>
  <vulnerability-report-tab
    :title="$options.i18n.containerRegistryTab"
    :fields="$options.FIELD_PRESETS.CONTAINER_REGISTRY"
    :filter-dropdowns="$options.FILTER_PRESETS.CONTAINER_REGISTRY_PROJECT"
    :filter-fn="transformFiltersContainerRegistry"
    :is-active-tab="isActiveTab"
  >
    <gl-loading-icon
      v-if="$apollo.queries.containerScanningData.loading"
      size="lg"
      class="gl-mt-8"
    />
    <gl-empty-state
      v-else-if="!hasContainerScanningForRegistryConfigured"
      :title="$options.i18n.emptyStateTitle"
      :svg-path="$options.secureEmptyStateSvg"
    >
      <template #description>
        <p class="gl-leading-20">
          <gl-sprintf :message="$options.i18n.emptyStateDescription">
            <template #link="{ content }">
              <gl-link :href="$options.DOC_PATH_CONTAINER_SCANNING_FOR_REGISTRY" target="_blank">
                {{ content }}
              </gl-link>
            </template>
          </gl-sprintf>
        </p>
      </template>
    </gl-empty-state>

    <template v-if="hasContainerScanningForRegistryConfigured" #header>
      <gl-alert
        v-if="!isAlertDismissed"
        class="gl-my-3"
        :title="$options.i18n.bannerTitle"
        :primary-button-link="$options.DOC_PATH_CONTAINER_SCANNING_FOR_REGISTRY"
        :primary-button-text="$options.i18n.learnMore"
        :secondary-button-text="$options.i18n.dismiss"
        @dismiss="dismissAlert"
        @secondaryAction="dismissAlert"
      >
        <gl-sprintf :message="$options.i18n.cvsMessage">
          >
          <template #link="{ content }">
            <gl-link :href="$options.DOC_PATH_CONTAINER_REGISTRY" target="_blank">
              {{ content }}
            </gl-link>
          </template>
        </gl-sprintf>
      </gl-alert>

      <gl-card v-else body-class="gl-p-6">{{ $options.i18n.containerRegistryTabMessage }}</gl-card>
    </template>
  </vulnerability-report-tab>
</template>
