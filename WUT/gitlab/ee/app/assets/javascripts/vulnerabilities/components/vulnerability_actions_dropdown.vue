<script>
import {
  GlAlert,
  GlButton,
  GlDisclosureDropdown,
  GlDisclosureDropdownItem,
  GlSprintf,
  GlLink,
  GlIcon,
} from '@gitlab/ui';
import { s__ } from '~/locale';
import { helpPagePath } from '~/helpers/help_page_helper';

const EXPLAIN_VULNERABILITY_ACTION = {
  name: 'explain-vulnerability',
  text: s__('AI|Explain with AI'),
  itemIcon: 'tanuki-ai',
  description: s__(
    'AI|Use GitLab Duo to provide insights about the vulnerability and suggested solutions.',
  ),
  // Note: This will add the testid to the button within the dropdown item. This is needed for qa specs.
  extraAttrs: { 'data-testid': 'explain-vulnerability-button' },
};

const RESOLVE_VULNERABILITY_ACTION = {
  name: 'resolve-vulnerability',
  text: s__('AI|Resolve with AI'),
  disabledStateLink: helpPagePath('/user/application_security/vulnerabilities/_index.md', {
    anchor: 'supported-vulnerabilities-for-vulnerability-resolution',
  }),
  itemIcon: 'tanuki-ai',
  description: s__('AI|Use GitLab Duo to generate a merge request with a suggested solution.'),
  disabledStateDescription: s__(
    'AI|GitLab Duo is unable to suggest a fix for this type of vulnerability.',
  ),
  warning: {
    text: s__(
      'AI|Creating an MR from a public project will publicly expose the vulnerability and offered resolution. To create the MR privately, see %{linkStart} Resolving a vulnerability privately%{linkEnd}.',
    ),
    link: helpPagePath('/user/application_security/vulnerabilities/_index', {
      anchor: 'vulnerability-resolution',
    }),
  },
};

const CREATE_MERGE_REQUEST_ACTION = {
  name: 'create-merge-request',
  text: s__('ciReport|Resolve with scanner suggestion'),
  description: s__("ciReport|Create a merge request to apply the scanner's software patch."),
};

const DOWNLOAD_PATCH_ACTION = {
  name: 'download-patch',
  text: s__('ciReport|Download Patch'),
  description: s__('ciReport|Download the patch provided by the scanner to apply it manually.'),
};

export default {
  components: {
    GlAlert,
    GlButton,
    GlDisclosureDropdown,
    GlDisclosureDropdownItem,
    GlSprintf,
    GlLink,
    GlIcon,
  },
  props: {
    loading: {
      type: Boolean,
      required: false,
      default: false,
    },
    showDownloadPatch: {
      type: Boolean,
      required: false,
      default: false,
    },
    showCreateMergeRequest: {
      type: Boolean,
      required: false,
      default: false,
    },
    showExplainWithAi: {
      type: Boolean,
      required: false,
      default: false,
    },
    showResolveWithAi: {
      type: Boolean,
      required: false,
      default: false,
    },
    aiResolutionEnabled: {
      type: Boolean,
      required: false,
      default: false,
    },
    showPublicProjectWarning: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  computed: {
    onlyAiActionsAvailable() {
      return !this.showDownloadPatch && !this.showCreateMergeRequest;
    },
    dropdownIcon() {
      return this.onlyAiActionsAvailable ? 'tanuki-ai' : '';
    },
    toggleText() {
      if (this.showDownloadPatch || this.showCreateMergeRequest) {
        return s__('AI|Resolutions');
      }

      return s__('AI|Explain or Resolve with AI');
    },
    availableActions() {
      const availableActions = [];

      if (this.showCreateMergeRequest) {
        availableActions.push(CREATE_MERGE_REQUEST_ACTION);
      }

      if (this.showDownloadPatch) {
        availableActions.push(DOWNLOAD_PATCH_ACTION);
      }

      if (this.showResolveWithAi) {
        availableActions.push({
          ...RESOLVE_VULNERABILITY_ACTION,
          ...(!this.aiResolutionEnabled && {
            disabled: true,
            extraAttrs: { disabled: true },
            description: RESOLVE_VULNERABILITY_ACTION.disabledStateDescription,
          }),
          showWarning: this.showPublicProjectWarning && this.aiResolutionEnabled,
        });
      }

      if (this.showExplainWithAi) {
        availableActions.push(EXPLAIN_VULNERABILITY_ACTION);
      }

      return availableActions;
    },
  },
  methods: {
    emitSelectedActionName({ name, disabled }) {
      if (!disabled) {
        this.$emit(name);
      }
    },
  },
};
</script>

<template>
  <gl-button
    v-if="availableActions.length === 1"
    variant="confirm"
    :title="availableActions[0].description"
    :icon="availableActions[0].itemIcon"
    :data-testid="`${availableActions[0].name}-action-button`"
    @click="$emit(availableActions[0].name)"
    >{{ availableActions[0].text }}</gl-button
  >
  <gl-disclosure-dropdown
    v-else-if="availableActions.length > 1"
    :toggle-text="toggleText"
    :loading="loading"
    :items="availableActions"
    :icon="dropdownIcon"
    variant="confirm"
    placement="bottom-end"
    class="gl-leading-20"
  >
    <div v-for="action in availableActions" :key="action.name">
      <gl-disclosure-dropdown-item
        :item="action"
        :class="{
          '!gl-bg-subtle': action.disabled,
        }"
        :data-testid="`${action.name}-action-dropdown-item`"
        @action="emitSelectedActionName"
      >
        <template #list-item>
          <span
            class="gl-flex gl-flex-col"
            :class="{
              'gl-cursor-not-allowed': action.disabled,
            }"
            :data-testid="`${action.name}-action-item`"
          >
            <span class="gl-mb-1 gl-flex">
              <gl-icon
                v-if="!dropdownIcon && action.itemIcon"
                :name="action.itemIcon"
                class="gl-mr-2"
                :data-testid="`vulnerability-action-icon-${action.name}`"
              />
              <span
                :data-testid="`${action.name}-action-title`"
                class="gl-whitespace-nowrap gl-font-bold"
                :class="{ 'gl-text-gray-300': action.disabled }"
                >{{ action.text }}</span
              >
            </span>
            <p class="gl-m-0 gl-p-0">
              <span
                :class="{ 'gl-text-gray-300': action.disabled }"
                :data-testid="`${action.name}-action-description`"
                >{{ action.description }}</span
              >
              <gl-link
                v-if="action.disabled && action.disabledStateLink"
                :href="action.disabledStateLink"
                target="_blank"
                class="!gl-text-link"
                :data-testid="`${action.name}-action-docs-link`"
                >{{ __('Learn more') }}</gl-link
              >
            </p>
          </span>
        </template>
      </gl-disclosure-dropdown-item>
      <gl-alert v-if="action.showWarning" variant="warning" :dismissible="false" class="gl-mb-1">
        <gl-sprintf :message="action.warning.text">
          <template #link="{ content }">
            <gl-link :href="action.warning.link" target="_blank" class="!gl-text-link">{{
              content
            }}</gl-link>
          </template>
        </gl-sprintf>
      </gl-alert>
    </div>
  </gl-disclosure-dropdown>
</template>
