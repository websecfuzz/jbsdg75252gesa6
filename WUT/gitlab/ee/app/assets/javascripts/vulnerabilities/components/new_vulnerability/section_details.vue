<script>
import {
  GlButton,
  GlIcon,
  GlFormGroup,
  GlFormInput,
  GlCollapsibleListbox,
  GlFormRadio,
  GlFormRadioGroup,
} from '@gitlab/ui';
import SeverityBadge from 'ee/vue_shared/security_reports/components/severity_badge.vue';
import IdentifiersTable from 'ee/vulnerabilities/components/new_vulnerability/identifiers_table.vue';
import SettingsSection from '~/vue_shared/components/settings/settings_section.vue';
import { VULNERABILITY_STATE_OBJECTS } from 'ee/vulnerabilities/constants';
import { SEVERITY_LEVELS } from 'ee/security_dashboard/constants';
import { s__, __ } from '~/locale';
import * as i18n from './i18n';

const DETECTION_METHODS = [
  s__('Vulnerability|GitLab Security Report'),
  s__('Vulnerability|External Security Report'),
  s__('Vulnerability|Bug Bounty'),
  s__('Vulnerability|Code Review'),
  s__('Vulnerability|Security Audit'),
];

export default {
  components: {
    GlButton,
    GlIcon,
    GlFormGroup,
    GlFormInput,
    GlCollapsibleListbox,
    GlFormRadio,
    GlFormRadioGroup,
    SeverityBadge,
    SettingsSection,
    IdentifiersTable,
  },
  props: {
    validationState: {
      type: Object,
      required: false,
      default: () => ({}),
    },
  },
  data() {
    return {
      // Note: The cvss field is disabled during the MVC because the backend implementation
      // is still missing. Since I learned this after implementing the design, I decided to
      // hide it from the UI until the backend is ready so that we don't lose the work
      // already completed.
      showCvss: false,
      cvss: '',
      statusId: '',
      severity: '',
      detectionMethod: -1,
    };
  },
  computed: {
    selectedSeverity() {
      return this.severityOptions.find(({ value }) => value === this.severity);
    },
    severityPlaceholder() {
      return this.selectedSeverity?.text || this.$options.i18n.severity.placeholder;
    },
    cvssDescription() {
      const scores = this.$options.cvss[this.selectedSeverity?.value];

      if (!scores) {
        return '';
      }

      return `${this.selectedSeverity.text}: ${scores[0].toFixed(1)} - ${scores[1].toFixed(1)}`;
    },
    detectionMethodPlaceholder() {
      return (
        this.detectionMethodOptions.find(({ value }) => value === this.detectionMethod)?.text ||
        this.$options.i18n.detectionMethod.placeholder
      );
    },
    detectionMethodOptions() {
      return DETECTION_METHODS.map((text, value) => ({ value, text }));
    },
    severityOptions() {
      return Object.entries(SEVERITY_LEVELS).map(([value, text]) => ({ value, text }));
    },
    statusOptions() {
      return [
        { ...VULNERABILITY_STATE_OBJECTS.detected },
        { ...VULNERABILITY_STATE_OBJECTS.confirmed },
        { ...VULNERABILITY_STATE_OBJECTS.resolved },
      ];
    },
  },
  methods: {
    selectSeverity(value) {
      this.severity = value;
      this.emitChanges();
    },

    selectDetectionMethod(value) {
      this.detectionMethod = value;
      this.emitChanges();
    },

    emitChanges() {
      this.$emit('change', {
        status: this.statusId,
        severity: this.severity,
        detectionMethod: this.detectionMethod,
      });
    },
    emitIdentifierChanges(payload) {
      this.$emit('change', payload);
    },
  },
  cvss: {
    none: [0, 0],
    low: [0.1, 3.9],
    medium: [4.0, 6.9],
    high: [7.0, 8.9],
    critical: [9.0, 10.0],
  },
  i18n: {
    errorSeverity: i18n.ERROR_SEVERITY,
    errorStatus: i18n.ERROR_STATUS,
    title: s__('Vulnerability|Details'),
    description: s__(
      'Vulnerability|Information related to how the vulnerability was discovered and its impact on the system.',
    ),
    detectionMethod: {
      label: s__('Vulnerability|Detection method'),
      placeholder: s__('VulnerabilityManagement|Select a method'),
    },
    severity: {
      label: s__('Vulnerability|Severity'),
      placeholder: s__('Vulnerability|Select a severity'),
    },
    cvssLabel: s__('Vulnerability|CVSS v3'),
    optional: __('Optional'),
    status: {
      label: __('Status'),
      description: s__(
        'Vulnerability|Set the status of the vulnerability finding based on the information available to you.',
      ),
    },
  },
};
</script>

<template>
  <settings-section :heading="$options.i18n.title" :description="$options.i18n.description">
    <gl-form-group
      :label="$options.i18n.detectionMethod.label"
      label-for="form-detection-method"
      class="gl-hidden"
    >
      <gl-collapsible-listbox
        id="form-detection-method"
        :items="detectionMethodOptions"
        :toggle-text="detectionMethodPlaceholder"
        :selected="detectionMethod"
        @select="selectDetectionMethod"
      />
    </gl-form-group>
    <div class="gl-mb-5 gl-flex">
      <gl-form-group
        :label="$options.i18n.severity.label"
        :state="validationState.severity"
        :invalid-feedback="$options.i18n.errorSeverity"
        label-for="form-severity"
        class="gl-mb-0 gl-mr-5"
      >
        <gl-collapsible-listbox
          id="form-severity"
          :items="severityOptions"
          :selected="severity"
          @select="selectSeverity"
        >
          <template #toggle>
            <gl-button button-text-classes="gl-inline-flex gl-gap-2">
              <template v-if="!severity">{{ severityPlaceholder }}</template>
              <severity-badge v-else :severity="severity" />
              <gl-icon aria-hidden="true" name="chevron-down" :size="16" variant="current" />
            </gl-button>
          </template>
          <template #list-item="{ item: { value } }">
            <severity-badge :severity="value" />
          </template>
        </gl-collapsible-listbox>
      </gl-form-group>
      <gl-form-group
        v-if="showCvss"
        label-for="form-cvss"
        :label="$options.i18n.cvssLabel"
        :description="cvssDescription"
        optional
        class="gl-mb-0"
      >
        <gl-form-input id="form-cvss" v-model="cvss" class="gl-mb-2" type="text" />
      </gl-form-group>
    </div>
    <gl-form-group
      :label="$options.i18n.status.label"
      :state="validationState.status"
      class="gl-mb-0"
    >
      <p class="gl-text-subtle">{{ $options.i18n.status.description }}</p>
      <gl-form-radio-group :checked="statusId" @change="emitChanges">
        <label
          v-for="status in statusOptions"
          :key="status.state"
          class="gl-mb-5 gl-flex gl-hyphens-auto gl-break-words gl-font-normal"
        >
          <gl-form-radio v-model="statusId" :value="status.state">
            {{ status.buttonText }}
            <template #help>
              <span class="gl-text-subtle">{{ status.description }}</span>
            </template>
          </gl-form-radio>
        </label>
      </gl-form-radio-group>

      <template #invalid-feedback>
        <p class="gl-mb-6">{{ $options.i18n.errorStatus }}</p>
      </template>
    </gl-form-group>

    <identifiers-table :validation-state="validationState" @change="emitIdentifierChanges" />
  </settings-section>
</template>
