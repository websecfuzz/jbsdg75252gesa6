<script>
import { GlFormGroup, GlFormInput, GlButton, GlTable } from '@gitlab/ui';
import CrudComponent from '~/vue_shared/components/crud_component.vue';
import { __, s__ } from '~/locale';
import * as i18n from './i18n';

export default {
  components: {
    GlFormGroup,
    GlFormInput,
    GlButton,
    GlTable,
    CrudComponent,
  },
  props: {
    validationState: {
      type: Object,
      required: false,
      default: () => ({}),
    },
  },
  data() {
    return {
      identifiers: [{ identifierCode: '', identifierUrl: '' }],
    };
  },
  computed: {
    rowAttr() {
      return { 'data-testid': 'identifier-row' };
    },
  },
  watch: {
    identifiers() {
      this.emitChanges();
    },
  },
  methods: {
    emitChanges() {
      this.$emit('change', {
        identifiers: this.identifiers.map((i) => ({
          name: i.identifierCode,
          url: i.identifierUrl,
        })),
      });
    },
    addIdentifier() {
      this.identifiers.push({ identifierCode: '', identifierUrl: '' });
    },
    removeIdentifier(index) {
      this.identifiers.splice(index, 1);
    },
    // null is when the user didn't input anything yet
    // false when the user provided invalid input and
    // true when the validation passes
    validationStateIdentifierUrl(index) {
      return this.validationState.identifiers?.[index]?.identifierUrl ?? null;
    },
    validationStateIdentifierCode(index) {
      return this.validationState.identifiers?.[index]?.identifierCode ?? null;
    },
    rowHasError(index) {
      return (
        this.validationStateIdentifierUrl(index) === false ||
        this.validationStateIdentifierCode(index) === false
      );
    },
  },
  i18n: {
    errorIdentifierCode: i18n.ERROR_IDENTIFIER_CODE,
    errorIdentifierUrl: i18n.ERROR_IDENTIFIER_URL,
    title: s__('Vulnerability|Identifiers'),
    description: s__(
      'Vulnerability|Enter the associated CVE or CWE entries for this vulnerability.',
    ),
    crudTitle: s__('Vulnerability|Vulnerability identifiers'),
    identifierCode: s__('Vulnerability|Identifier code'),
    identifierUrl: s__('Vulnerability|Identifier URL'),
    addIdentifier: s__('Vulnerability|Add another identifier'),
    removeIdentifierRow: s__('Vulnerability|Remove identifier row'),
  },
  fields: [
    {
      key: 'code',
      label: s__('Vulnerability|Identifier code'),
      tdClass: 'gl-w-48',
    },
    {
      key: 'url',
      label: s__('Vulnerability|Identifier URL'),
    },
    {
      key: 'actions',
      label: __('Actions'),
      thClass: 'gl-sr-only',
      tdClass: 'gl-w-6 gl-text-right',
    },
  ],
};
</script>

<template>
  <crud-component :title="$options.i18n.crudTitle" :description="$options.i18n.description">
    <template #actions>
      <gl-button size="small" @click="addIdentifier">{{ $options.i18n.addIdentifier }}</gl-button>
    </template>

    <gl-table :items="identifiers" :fields="$options.fields" :tbody-tr-attr="rowAttr" stacked="md">
      <template #cell(code)="{ item, index }">
        <gl-form-group
          :label="$options.i18n.identifierCode"
          :label-for="`form-identifier-code-${index}`"
          label-class="gl-sr-only"
          :state="validationStateIdentifierCode(index)"
          :invalid-feedback="$options.i18n.errorIdentifierCode"
          class="gl-mb-0"
        >
          <gl-form-input
            :id="`form-identifier-code-${index}`"
            v-model.trim="item.identifierCode"
            :placeholder="__('Code')"
            :state="validationStateIdentifierCode(index)"
            type="text"
            @input="emitChanges"
          />
        </gl-form-group>
      </template>

      <template #cell(url)="{ item, index }">
        <gl-form-group
          :label="$options.i18n.identifierUrl"
          :label-for="`form-identifier-url-${index}`"
          label-class="gl-sr-only"
          :state="validationStateIdentifierUrl(index)"
          :invalid-feedback="$options.i18n.errorIdentifierUrl"
          class="gl-mb-0"
        >
          <gl-form-input
            :id="`form-identifier-url-${index}`"
            v-model.trim="item.identifierUrl"
            :state="validationStateIdentifierUrl(index)"
            type="text"
            @input="emitChanges"
          />
        </gl-form-group>
      </template>

      <template #cell(actions)="{ index }">
        <gl-button
          v-if="index > 0"
          class="!gl-shadow-none"
          :class="rowHasError(index) ? 'gl-self-center' : 'gl-self-end'"
          icon="remove"
          category="tertiary"
          :aria-label="$options.i18n.removeIdentifierRow"
          @click="removeIdentifier(index)"
        />
        <gl-button v-else class="gl-invisible gl-self-end gl-shadow-none" icon="remove" />
      </template>
    </gl-table>
  </crud-component>
</template>
