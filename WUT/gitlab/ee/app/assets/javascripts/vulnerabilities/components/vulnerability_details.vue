<script>
import {
  GlFriendlyWrap,
  GlLink,
  GlSprintf,
  GlButton,
  GlTooltipDirective,
  GlLabel,
} from '@gitlab/ui';
import { isEmpty } from 'lodash';
import SafeHtml from '~/vue_shared/directives/safe_html';
import { renderGFM } from '~/behaviors/markdown/render_gfm';
import { bodyWithFallBack } from 'ee/vue_shared/security_reports/components/helpers';
import SeverityBadge from 'ee/vue_shared/security_reports/components/severity_badge.vue';
import TokenValidityBadge from 'ee/vue_shared/security_reports/components/token_validity_badge.vue';
import convertReportType from 'ee/vue_shared/security_reports/store/utils/convert_report_type';
import {
  SUPPORTING_MESSAGE_TYPES,
  VULNERABILITY_TRAINING_HEADING,
} from 'ee/vulnerabilities/constants';
import { s__, __ } from '~/locale';
import CodeBlock from '~/vue_shared/components/code_block.vue';
import glFeatureFlagMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import glAbilitiesMixin from '~/vue_shared/mixins/gl_abilities_mixin';
import HelpPopover from '~/vue_shared/components/help_popover.vue';
import { setTabIndexForCodeFlowPage } from 'ee/vulnerabilities/helpers';
import {
  COLORS,
  REACHABILITY_TYPE,
} from 'ee/security_dashboard/components/shared/vulnerability_report/constants';
import DetailItem from './detail_item.vue';
import FalsePositiveAlert from './false_positive_alert.vue';
import VulnerabilityDetailSection from './vulnerability_detail_section.vue';
import VulnerabilityTraining from './vulnerability_training.vue';
import VulnerabilityFileContents from './vulnerability_file_contents.vue';
import DependencyPath from './dependency_path.vue';

export default {
  name: 'VulnerabilityDetails',
  components: {
    CodeBlock,
    FalsePositiveAlert,
    GlLink,
    SeverityBadge,
    TokenValidityBadge,
    DetailItem,
    GlFriendlyWrap,
    GlSprintf,
    VulnerabilityDetailSection,
    VulnerabilityTraining,
    VulnerabilityFileContents,
    GlTooltipDirective,
    GlButton,
    GlLabel,
    HelpPopover,
    DependencyPath,
  },
  directives: {
    SafeHtml,
  },
  mixins: [glFeatureFlagMixin(), glAbilitiesMixin()],
  inject: {
    projectFullPath: {
      default: '',
    },
  },
  props: {
    vulnerability: {
      type: Object,
      required: true,
    },
  },
  computed: {
    humanReadableReportType() {
      return convertReportType(this.vulnerability.reportType);
    },
    location() {
      return this.vulnerability.location || {};
    },
    scanner() {
      return this.vulnerability.scanner || {};
    },
    fileText() {
      return (this.location.file || '') + (this.lineNumber ? `:${this.lineNumber}` : '');
    },
    fileUrl() {
      const {
        lineNumber,
        location: { blobPath },
      } = this;

      if (!blobPath) {
        return '';
      }

      // if the blobPath already contains a hash, we don't want to add another one
      if (!lineNumber || blobPath.includes('#')) {
        return blobPath;
      }

      return `${blobPath}#L${lineNumber}`;
    },
    isFalsePositive() {
      return Boolean(this.vulnerability.falsePositive);
    },
    lineNumber() {
      const { startLine: start, endLine: end } = this.location;
      return end > start ? `${start}-${end}` : start;
    },
    requestOrLocationUrl() {
      return this.vulnerability.request?.url || this.locationUrl;
    },
    locationUrl() {
      const { hostname, path } = this.location;
      return typeof hostname === 'string' && typeof path === 'string' ? `${hostname}${path}` : '';
    },
    scannerUrl() {
      return this.scanner.url || '';
    },
    scannerDetails() {
      if (this.scannerUrl) {
        return {
          component: 'GlLink',
          properties: {
            href: this.scannerUrl,
            target: '_blank',
          },
        };
      }

      return {
        component: 'span',
        properties: {},
      };
    },
    assertion() {
      return this.vulnerability.evidenceSource?.name;
    },
    recordedMessage() {
      return this.vulnerability?.supportingMessages?.find(
        (msg) => msg.name === SUPPORTING_MESSAGE_TYPES.RECORDED,
      )?.response;
    },
    constructedRequest() {
      return this.constructRequest(this.vulnerability.request);
    },
    constructedResponse() {
      return this.constructResponse(this.vulnerability.response);
    },
    constructedRecordedResponse() {
      return this.constructResponse(this.recordedMessage);
    },
    project() {
      return this.vulnerability.project;
    },
    requestData() {
      if (!this.vulnerability.request) {
        return [];
      }

      return [
        {
          label: __('%{labelStart}Sent request:%{labelEnd} %{headers}'),
          content: this.constructedRequest,
          isCode: true,
        },
      ].filter((x) => x.content);
    },
    responseData() {
      if (!this.vulnerability.response) {
        return [];
      }

      return [
        {
          label: __('%{labelStart}Actual response:%{labelEnd} %{headers}'),
          content: this.constructedResponse,
          isCode: true,
        },
      ].filter((x) => x.content);
    },
    recordedResponseData() {
      if (!this.recordedMessage) {
        return [];
      }

      return [
        {
          label: __('%{labelStart}Unmodified response:%{labelEnd} %{headers}'),
          content: this.constructedRecordedResponse,
          isCode: true,
        },
      ].filter((x) => x.content);
    },
    shouldShowLocation() {
      return (
        this.location.crashAddress ||
        this.location.crashState ||
        this.location.crashType ||
        this.location.stacktraceSnippet ||
        this.location.file ||
        this.location.image ||
        this.location.operatingSystem
      );
    },
    hasRequest() {
      return Boolean(this.requestData.length);
    },
    hasResponse() {
      return Boolean(this.responseData.length);
    },
    hasRecordedResponse() {
      return Boolean(this.recordedResponseData.length);
    },
    hasResponses() {
      return Boolean(this.hasResponse || this.hasRecordedResponse);
    },
    shouldShowTraining() {
      return this.vulnerability.identifiers?.length > 0 && Boolean(this.projectFullPath);
    },
    vulnerableMethod() {
      // `location.method` is provided by the REST API and `location.vulnerableMethod` by GraphQL
      // once https://gitlab.com/groups/gitlab-org/-/epics/3657 and https://gitlab.com/groups/gitlab-org/-/epics/8054 have been completed we can remove the support for `location.method`
      return this.location.method || this.location.vulnerableMethod;
    },
    shouldShowFileContents() {
      // Only show file contents if there's a file and a start line. The start line check prevents the entire file from
      // being shown if there's no start line, for example dependency scanning results.
      return this.vulnerability.location?.file && this.vulnerability.location?.startLine;
    },
    showCodeFlowButton() {
      return (
        this.vulnerability?.details?.codeFlows && !isEmpty(this.vulnerability.details.codeFlows)
      );
    },
    hasDependencyPaths() {
      return this.vulnerability?.sbomOccurrences?.some((o) => o.hasDependencyPaths);
    },
    component() {
      if (!this.hasDependencyPaths) {
        return null;
      }

      return {
        name: this.location?.dependency.package.name,
        version: this.location?.dependency.version,
      };
    },
    hasCVSSData() {
      return this.vulnerability.cvss?.length > 0;
    },
    hasCveEnrichmentData() {
      return Boolean(this.vulnerability.cveEnrichment);
    },
    epssColor() {
      let color = COLORS.info;
      const score = parseFloat(this.epssScore);

      if (score >= 76) {
        color = COLORS.critical;
      } else if (score >= 51) {
        color = COLORS.high;
      } else if (score >= 26) {
        color = COLORS.medium;
      } else if (score >= 1) {
        color = COLORS.low;
      }

      return color;
    },
    epssScore() {
      return `${Math.round(this.vulnerability.cveEnrichment.epssScore * 100)}%`;
    },
    kevColor() {
      return this.vulnerability.cveEnrichment.isKnownExploit ? COLORS.critical : COLORS.info;
    },
    reachabilityColor() {
      return REACHABILITY_TYPE[this.vulnerability.reachability].color;
    },
    reachabilityTitle() {
      return REACHABILITY_TYPE[this.vulnerability.reachability].title;
    },
    shouldRenderValidityCheck() {
      return (
        this.glFeatures.validityChecks &&
        this.vulnerability.reportType === 'secret_detection' &&
        this.vulnerability.validityChecksEnabled
      );
    },
    tokenValidityStatus() {
      return this.vulnerability.findingTokenStatus?.status || 'unknown';
    },
  },
  mounted() {
    renderGFM(this.$refs.markdownContent);
  },
  methods: {
    getHeadersAsCodeBlockLines(headers) {
      return Array.isArray(headers)
        ? headers.map(({ name, value }) => `${name}: ${value}`).join('\n')
        : '';
    },
    constructResponse(response) {
      const { body, statusCode, reasonPhrase = '', headers = [] } = response;
      const headerLines = this.getHeadersAsCodeBlockLines(headers);

      return statusCode && headerLines
        ? [`${statusCode} ${reasonPhrase}\n`, headerLines, '\n\n', bodyWithFallBack(body)].join('')
        : '';
    },
    constructRequest(request) {
      const { body, method, url, headers = [] } = request;
      const headerLines = this.getHeadersAsCodeBlockLines(headers);

      return method && url && headerLines
        ? [`${method} ${url}\n`, headerLines, '\n\n', bodyWithFallBack(body)].join('')
        : '';
    },
    redirectToCodeFlowTab() {
      setTabIndexForCodeFlowPage(this.$router, { path: '/', index: 1 });
    },
    cvssColor(score) {
      let color = COLORS.info;

      if (score >= 9) {
        color = COLORS.critical;
      } else if (score >= 7) {
        color = COLORS.high;
      } else if (score >= 4) {
        color = COLORS.medium;
      } else if (score >= 0.1) {
        color = COLORS.low;
      }

      return color;
    },
    cvssVersion(cvss) {
      return `v${cvss.version}`;
    },
  },
  i18n: {
    whatIsCvss: {
      content: s__(
        'Vulnerability|The CVSS (Common Vulnerability Scoring System) is a standardized framework for assessing and communicating the severity of security vulnerabilities in software. It provides a numerical score (ranging from 0.0 to 10.0) to indicate the severity risk of the vulnerability.',
      ),
      title: s__('Vulnerability|What is CVSS?'),
    },
    whatIsEpss: {
      content: s__(
        'Vulnerability|The Exploit Prediction Scoring System model produces a percentage value between 0 and 100 that represents the likelihood that a vulnerability will be exploited in the next 30 days.',
      ),
      title: s__('Vulnerability|What is EPSS?'),
    },
    whatIsKev: {
      content: s__(
        'Vulnerability|CISA (the Cybersecurity & Infrastructure Security Agency, a part of the U.S. Department of Homeland Security) maintains the Known Exploited Vulnerabilities (aka "KEV") catalog of vulnerabilities that have been exploited in the wild.',
      ),
      title: s__("Vulnerability|What is 'Has known exploit (KEV)'?"),
    },
    requestResponse: s__('Vulnerability|Request/Response'),
    unmodifiedResponse: s__(
      'Vulnerability|The unmodified response is the original response that had no mutations done to the request',
    ),
    actualResponse: s__(
      'Vulnerability|Actual received response is the one received when this fault was detected',
    ),
    codeFlowButton: s__('Vulnerability|View code flow'),
    whatIsReachability: {
      content: s__(
        'Vulnerability|Static reachability is a factor of dependencies (and the relevant CVEs) which indicates that there is a high probability that the package is in use, and therefore the risk of it is higher.',
      ),
      title: s__('Vulnerability|What is Reachability?'),
    },
  },
  VULNERABILITY_TRAINING_HEADING,
};
</script>

<template>
  <div data-testid="vulnerability-details">
    <false-positive-alert v-if="isFalsePositive" class="gl-mb-5" />

    <div class="md">
      <h3>{{ __('Description') }}</h3>
      <p
        v-if="vulnerability.descriptionHtml"
        ref="markdownContent"
        v-safe-html="vulnerability.descriptionHtml"
        data-testid="description"
      ></p>
      <p v-else data-testid="description">
        {{ vulnerability.description }}
      </p>

      <ul>
        <detail-item :sprintf-message="__('%{labelStart}Severity:%{labelEnd} %{severity}')">
          <severity-badge
            :severity="vulnerability.severity"
            :severity-override="vulnerability.severityOverride"
            :show-severity-overrides="true"
            class="gl-ml-2 gl-inline"
          />
        </detail-item>

        <detail-item
          v-if="shouldRenderValidityCheck"
          :show-experiment-badge="true"
          :sprintf-message="__('%{labelStart}Validity check:%{labelEnd} %{validityCheck}')"
        >
          <token-validity-badge :status="tokenValidityStatus" />
        </detail-item>

        <detail-item
          v-if="hasCVSSData"
          :sprintf-message="__('%{labelStart}CVSS:%{labelEnd} %{cvss}')"
        >
          <div class="gl-inline-block">
            <b>{{ cvssVersion(vulnerability.cvss[0]) }}</b>
            <gl-label
              :background-color="cvssColor(vulnerability.cvss[0].overallScore)"
              :title="vulnerability.cvss[0].overallScore.toString()"
            />
          </div>
          <help-popover class="gl-ml-2" :options="$options.i18n.whatIsCvss" />
        </detail-item>

        <template v-if="hasCveEnrichmentData">
          <detail-item :sprintf-message="__('%{labelStart}EPSS:%{labelEnd} %{epss}')">
            <gl-label :background-color="epssColor" :title="epssScore" />
            <help-popover class="gl-ml-2" :options="$options.i18n.whatIsEpss" />
          </detail-item>

          <detail-item
            :sprintf-message="__('%{labelStart}Has Known Exploit (KEV):%{labelEnd} %{kev}')"
          >
            <gl-label
              :background-color="kevColor"
              :title="vulnerability.cveEnrichment.isKnownExploit ? __('Yes') : __('No')"
            />
            <help-popover class="gl-ml-2" :options="$options.i18n.whatIsKev" />
          </detail-item>
        </template>

        <detail-item
          v-if="project"
          :sprintf-message="__('%{labelStart}Project:%{labelEnd} %{project}')"
        >
          <gl-link :href="project.fullPath" target="_blank">{{ project.fullName }}</gl-link>
        </detail-item>
        <detail-item
          v-if="glFeatures.vulnerabilityReportTypeScannerFilter"
          :sprintf-message="__('%{labelStart}Report type:%{labelEnd} %{reportType}')"
          >{{ humanReadableReportType }}</detail-item
        >
        <detail-item v-else :sprintf-message="__('%{labelStart}Tool:%{labelEnd} %{reportType}')">{{
          humanReadableReportType
        }}</detail-item>
        <detail-item
          v-if="scanner.name"
          :sprintf-message="__('%{labelStart}Scanner:%{labelEnd} %{scanner}')"
        >
          <component
            :is="scannerDetails.component"
            v-bind="scannerDetails.properties"
            data-testid="scannerSafeLink"
          >
            <gl-sprintf
              v-if="scanner.version"
              :message="s__('Vulnerability|%{scannerName} (version %{scannerVersion})')"
            >
              <template #scannerName>{{ scanner.name }}</template>
              <template #scannerVersion>{{ scanner.version }}</template>
            </gl-sprintf>
            <template v-else>{{ scanner.name }}</template>
          </component>
        </detail-item>
        <detail-item
          v-if="location.class"
          :sprintf-message="__('%{labelStart}Class:%{labelEnd} %{class}')"
          >{{ location.class }}
        </detail-item>
        <detail-item
          v-if="vulnerableMethod"
          :sprintf-message="__('%{labelStart}Method:%{labelEnd} %{method}')"
        >
          <code>{{ vulnerableMethod }}</code>
        </detail-item>
        <detail-item
          v-if="requestOrLocationUrl"
          :sprintf-message="__('%{labelStart}URL:%{labelEnd} %{url}')"
        >
          <gl-link :href="requestOrLocationUrl" target="_blank">
            <gl-friendly-wrap :text="requestOrLocationUrl" />
          </gl-link>
        </detail-item>
        <detail-item
          v-if="vulnerability.evidence"
          :sprintf-message="__('%{labelStart}Evidence:%{labelEnd} %{evidence}')"
          >{{ vulnerability.evidence }}
        </detail-item>
        <detail-item
          v-if="vulnerability.reachability"
          :sprintf-message="__('%{labelStart}Reachable:%{labelEnd} %{reachability}')"
        >
          <gl-label :background-color="reachabilityColor" :title="reachabilityTitle" />
          <help-popover class="gl-ml-2" :options="$options.i18n.whatIsReachability" />
        </detail-item>
      </ul>

      <template v-if="shouldShowLocation">
        <h3 id="vulnerability-details-location">{{ __('Location') }}</h3>
        <ul>
          <detail-item
            v-if="location.image"
            :sprintf-message="__('%{labelStart}Image:%{labelEnd} %{image}')"
          >
            <gl-link
              v-if="location.containerRepositoryUrl"
              :href="location.containerRepositoryUrl"
              target="_blank"
              >{{ location.image }}</gl-link
            >
            <template v-else>{{ location.image }}</template>
          </detail-item>
          <detail-item
            v-if="location.operatingSystem"
            :sprintf-message="__('%{labelStart}Namespace:%{labelEnd} %{namespace}')"
            >{{ location.operatingSystem }}
          </detail-item>
          <detail-item
            v-if="location.file"
            :sprintf-message="__('%{labelStart}File:%{labelEnd} %{file}')"
          >
            <gl-link :href="fileUrl" target="_blank">{{ fileText }}</gl-link>
          </detail-item>
          <vulnerability-file-contents v-if="shouldShowFileContents" :location="location" />
          <detail-item
            v-if="location.crashAddress"
            :sprintf-message="__('%{labelStart}Crash Address:%{labelEnd} %{crash_address}')"
            >{{ location.crashAddress }}
          </detail-item>
          <detail-item
            v-if="location.crashType"
            :sprintf-message="__('%{labelStart}Crash Type:%{labelEnd} %{crash_type}')"
            >{{ location.crashType }}
          </detail-item>
          <detail-item
            v-if="location.crashState"
            :sprintf-message="__('%{labelStart}Crash State:%{labelEnd} %{crash_state}')"
            >{{ location.crashState }}
          </detail-item>
          <detail-item
            v-if="location.stacktraceSnippet"
            :sprintf-message="__('%{labelStart}Crash State:%{labelEnd} %{stacktrace_snippet}')"
          >
            <code-block :code="location.stacktraceSnippet" max-height="225px" />
          </detail-item>
        </ul>
        <dependency-path
          v-if="glFeatures.dependencyPaths && hasDependencyPaths"
          :component="component"
          :sbom-occurrences="vulnerability.sbomOccurrences"
        />
      </template>

      <gl-button
        v-if="showCodeFlowButton"
        category="primary"
        variant="default"
        data-testid="show-code-flow"
        @click="redirectToCodeFlowTab"
      >
        {{ $options.i18n.codeFlowButton }}
      </gl-button>

      <template v-if="vulnerability.links && vulnerability.links.length">
        <h3>{{ __('Links') }}</h3>
        <ul>
          <li
            v-for="(link, index) in vulnerability.links"
            :key="`${index}:${link.url}`"
            class="!gl-ml-0 gl-list-inside"
          >
            <gl-link
              :href="link.url"
              data-testid="link"
              target="_blank"
              :aria-label="__('Third Party Advisory Link')"
              :title="link.url"
            >
              {{ link.name || link.url }}
            </gl-link>
          </li>
        </ul>
      </template>

      <template v-if="vulnerability.identifiers && vulnerability.identifiers.length">
        <h3>{{ __('Identifiers') }}</h3>
        <ul>
          <li
            v-for="(identifier, index) in vulnerability.identifiers"
            :key="`${index}:${identifier.url}`"
            class="!gl-ml-0 gl-list-inside"
          >
            <component
              :is="identifier.url ? 'gl-link' : 'span'"
              v-bind="identifier.url && { href: identifier.url, target: '_blank' }"
              data-testid="identifier"
            >
              {{ identifier.name }}
            </component>
          </li>
        </ul>
      </template>

      <vulnerability-detail-section
        v-if="hasRequest"
        data-testid="request"
        :list-data="requestData"
        :heading="$options.i18n.requestResponse"
      />

      <div v-if="hasResponses" class="row">
        <vulnerability-detail-section
          v-if="hasRecordedResponse"
          data-testid="recorded-response"
          :class="hasResponse ? 'col-6' : 'col'"
          :list-data="recordedResponseData"
          :icon-title="$options.i18n.unmodifiedResponse"
        />

        <vulnerability-detail-section
          v-if="hasResponse"
          data-testid="response"
          :class="hasRecordedResponse ? 'col-6' : 'col'"
          :list-data="responseData"
          :icon-title="$options.i18n.actualResponse"
        />
      </div>

      <template v-if="assertion">
        <h3>{{ s__('Vulnerability|Additional Info') }}</h3>
        <ul>
          <detail-item :sprintf-message="__('%{labelStart}Assert:%{labelEnd} %{assertion}')">
            {{ assertion }}
          </detail-item>
        </ul>
      </template>

      <template v-if="vulnerability.assets && vulnerability.assets.length">
        <h3>{{ s__('Vulnerability|Reproduction Assets') }}</h3>
        <ul>
          <li
            v-for="(asset, index) in vulnerability.assets"
            :key="`${index}:${asset.url}`"
            class="!gl-ml-0 gl-list-inside"
          >
            <component
              :is="asset.url ? 'gl-link' : 'span'"
              v-bind="asset.url && { href: asset.url, target: '_blank' }"
              data-testid="asset"
            >
              {{ asset.name }}
            </component>
          </li>
        </ul>
      </template>

      <vulnerability-training
        v-if="shouldShowTraining"
        :project-full-path="projectFullPath"
        :identifiers="vulnerability.identifiers"
        :file="location.file"
        class="gl-mb-5"
      >
        <template #header>
          <h3>{{ $options.VULNERABILITY_TRAINING_HEADING.title }}</h3>
        </template>
      </vulnerability-training>
    </div>
  </div>
</template>
