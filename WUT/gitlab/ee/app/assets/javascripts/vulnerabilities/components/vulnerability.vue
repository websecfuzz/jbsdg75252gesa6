<!-- eslint-disable vue/multi-word-component-names -->
<script>
import { GlTab, GlTabs, GlAlert, GlSprintf, GlLink } from '@gitlab/ui';
import { isEmpty } from 'lodash';
import fetchHeaderVulnerabilityQuery from 'ee/security_dashboard/graphql/header_vulnerability.graphql';
import { convertToGraphQLId } from '~/graphql_shared/utils';
import { TYPENAME_VULNERABILITY } from '~/graphql_shared/constants';
import { fetchPolicies } from '~/lib/graphql';
import { s__, __ } from '~/locale';
import { createAlert } from '~/alert';
import { helpPagePath } from '~/helpers/help_page_helper';
import {
  CODE_FLOW_TAB_URL,
  VULNERABILITY_TAB_INDEX_TO_NAME,
  VULNERABILITY_TAB_NAMES,
} from 'ee/vulnerabilities/constants';
import VulnerabilityCodeFlow from 'ee/vue_shared/components/code_flow/vulnerability_code_flow.vue';
import StickyVulnerabilityHeader from 'ee/vulnerabilities/components/sticky_vulnerability_header.vue';
import {
  getTabIndexForCodeFlowPage,
  normalizeGraphQLVulnerability,
  setTabIndexForCodeFlowPage,
} from '../helpers';
import VulnerabilityFooter from './footer.vue';
import VulnerabilityHeader from './header.vue';
import VulnerabilityDetails from './vulnerability_details.vue';

export default {
  components: {
    VulnerabilityHeader,
    VulnerabilityDetails,
    VulnerabilityCodeFlow,
    VulnerabilityFooter,
    StickyVulnerabilityHeader,
    GlTabs,
    GlTab,
    GlAlert,
    GlSprintf,
    GlLink,
  },
  inject: ['projectFullPath', 'defaultBranch'],
  props: {
    initialVulnerability: {
      type: Object,
      required: true,
    },
  },
  data() {
    return {
      shouldSkipQuery: true,
      vulnerability: { ...this.initialVulnerability },
    };
  },
  computed: {
    tabIndex: {
      get() {
        return getTabIndexForCodeFlowPage(this.$route);
      },
      set(index) {
        setTabIndexForCodeFlowPage(this.$router, {
          path: '/',
          index,
          selectedIndex: this.tabIndex,
        });
      },
    },
    showCodeFlowTabs() {
      return (
        this.vulnerability?.details?.codeFlows && !isEmpty(this.vulnerability.details.codeFlows)
      );
    },
    tabsArr() {
      const detailsTab = [
        VULNERABILITY_TAB_INDEX_TO_NAME[0], // tab naming in the URL
        this.$options.i18n.VULNERABILITY_TAB_NAMES.DETAILS, // tab title
        `${this.$route.query.tab ? `${this.$options.i18n.inactive}\`}` : `${this.$options.i18n.active}`}`, // the active tab
      ];
      const codeFlowTab = [
        VULNERABILITY_TAB_INDEX_TO_NAME[1],
        this.$options.i18n.VULNERABILITY_TAB_NAMES.CODE_FLOW,
        `${this.$route.query.tab ? `${this.$options.i18n.active}` : `${this.$options.i18n.inactive}`}`,
      ];
      return [detailsTab, codeFlowTab];
    },
    isAboutToBeArchived() {
      return this.vulnerability.archivalInformation.aboutToBeArchived;
    },
    expectedToBeArchivedOn() {
      if (!this.vulnerability.archivalInformation.expectedToBeArchivedOn) {
        return '';
      }

      return this.vulnerability.archivalInformation.expectedToBeArchivedOn.split('T')[0];
    },
  },
  apollo: {
    vulnerability: {
      manual: true,
      query: fetchHeaderVulnerabilityQuery,
      fetchPolicy: fetchPolicies.NO_CACHE,
      variables() {
        return {
          id: convertToGraphQLId(TYPENAME_VULNERABILITY, this.vulnerability.id),
        };
      },
      result({ data: { vulnerability } = {} }) {
        this.shouldSkipQuery = true;
        this.vulnerability = {
          ...this.vulnerability,
          ...normalizeGraphQLVulnerability(vulnerability),
        };
      },
      error() {
        createAlert({
          message: s__(
            'VulnerabilityManagement|Something went wrong while trying to refresh the vulnerability. Please try again later.',
          ),
        });
      },
      skip() {
        return this.shouldSkipQuery;
      },
    },
  },
  methods: {
    refetchVulnerability() {
      this.shouldSkipQuery = false;
      this.$apollo.queries.vulnerability.refetch();
    },
    updateVulnerability(newVulnerability) {
      this.vulnerability = newVulnerability;
    },
  },
  i18n: {
    VULNERABILITY_TAB_NAMES,
    CODE_FLOW_TAB_URL,
    active: __('Active'),
    inactive: __('Inactive'),
    archivePending: s__('Vulnerability|Archive pending'),
    archivalNotice: s__(
      'Vulnerability|Vulnerability will be archived on %{date}. %{linkStart}Why will this vulnerability be archived?%{linkEnd}',
    ),
  },
  vulnerabilityArchivalLearnMorePath: helpPagePath(
    'user/application_security/vulnerability_archival/_index.md',
  ),
};
</script>

<template>
  <div>
    <gl-alert
      v-if="isAboutToBeArchived"
      :title="$options.i18n.archivePending"
      variant="warning"
      class="gl-mt-4"
      :dismissible="false"
      ><gl-sprintf :message="$options.i18n.archivalNotice">
        <template #link="{ content }">
          <gl-link :href="$options.vulnerabilityArchivalLearnMorePath">{{ content }}</gl-link>
        </template>
        <template #date>{{ expectedToBeArchivedOn }}</template>
      </gl-sprintf></gl-alert
    >

    <vulnerability-header
      ref="header"
      :vulnerability="vulnerability"
      @vulnerability-state-change="updateVulnerability"
      @vulnerability-severity-change="updateVulnerability"
    />
    <div>
      <sticky-vulnerability-header
        v-if="showCodeFlowTabs"
        :vulnerability="vulnerability"
        :tabs="tabsArr"
      />

      <h1
        v-if="vulnerability.title"
        ref="vulnerabilityTitle"
        class="gl-mb-0 gl-mt-0 gl-border-b-0 gl-pb-2 gl-pt-5"
        data-testid="title"
      >
        {{ vulnerability.title }}
      </h1>

      <gl-tabs v-if="showCodeFlowTabs" v-model="tabIndex">
        <gl-tab :title="$options.i18n.VULNERABILITY_TAB_NAMES.DETAILS">
          <vulnerability-details :vulnerability="vulnerability" class="gl-pt-5" />
        </gl-tab>

        <gl-tab :title="$options.i18n.VULNERABILITY_TAB_NAMES.CODE_FLOW">
          <vulnerability-code-flow
            :branch-ref="defaultBranch"
            :details="vulnerability.details.codeFlows"
            :project-full-path="projectFullPath"
            :description="vulnerability.description"
            :description-html="vulnerability.descriptionHtml"
          />
        </gl-tab>
      </gl-tabs>

      <template v-else>
        <vulnerability-details :vulnerability="vulnerability" />
      </template>
    </div>

    <vulnerability-footer
      v-if="tabIndex === 0"
      ref="footer"
      :vulnerability="vulnerability"
      @vulnerability-state-change="refetchVulnerability"
    />
  </div>
</template>
