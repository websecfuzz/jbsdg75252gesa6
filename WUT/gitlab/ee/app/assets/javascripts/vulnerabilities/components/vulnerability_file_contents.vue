<script>
import { GlSkeletonLoader, GlAlert, GlSprintf } from '@gitlab/ui';
import * as Sentry from '~/sentry/sentry_browser_wrapper';
import vulnerabilityBlobInfoQuery from 'ee/security_dashboard/graphql/queries/vulnerability_blob_info.query.graphql';
import VulnerabilityFileContentViewer from 'ee/vue_shared/vulnerabilities/components/vulnerability_file_content_viewer.vue';
import { getRefFromBlobPath } from 'ee/vulnerabilities/helpers';
import { highlightContent } from '~/highlight_js';
import { s__ } from '~/locale';

export default {
  components: {
    VulnerabilityFileContentViewer,
    GlSkeletonLoader,
    GlAlert,
    GlSprintf,
  },
  inject: ['projectFullPath'],
  props: {
    location: { type: Object, required: true },
  },
  data() {
    return {
      blobContent: null,
      loadingError: false,
      highlightedContent: '',
    };
  },
  apollo: {
    blobContent: {
      query: vulnerabilityBlobInfoQuery,
      variables() {
        return {
          projectPath: this.projectFullPath,
          filePath: this.location.file,
          // The ref (commit SHA) is important. We need to get the blob info for the commit that the vulnerability was
          // found in, because the file could've been changed or deleted on the default branch.
          ref: this.ref,
        };
      },
      update({ project }) {
        const data = project.repository.blobs.nodes[0];
        if (!data) return data;

        highlightContent(data.language, data.rawTextBlob)
          .then((res) => {
            this.highlightedContent = res;
          })
          .catch((error) => {
            Sentry.captureException(error);
          });
        return data.rawTextBlob;
      },
      error() {
        this.loadingError = true;
      },
    },
  },
  computed: {
    isHighlighted() {
      return Boolean(this.highlightedContent);
    },
    content() {
      return this.highlightedContent || this.blobContent;
    },

    startLine() {
      return this.location.startLine;
    },
    endLine() {
      return this.location.endLine || this.startLine;
    },
    ref() {
      return getRefFromBlobPath(this.location.blobPath);
    },
  },
  i18n: {
    vulnerabilityNotFound: s__('Vulnerability|%{file} was not found in commit %{ref}'),
  },
};
</script>

<template>
  <div
    v-if="$apollo.queries.blobContent.loading"
    class="code code-syntax-highlight-theme gl-rounded-base gl-p-3 gl-pb-2"
  >
    <gl-skeleton-loader />
  </div>

  <gl-alert
    v-else-if="loadingError"
    :dismissible="false"
    variant="danger"
    data-testid="loading-error"
  >
    {{ s__('Vulnerability|Something went wrong while trying to get the source file.') }}
  </gl-alert>

  <gl-alert
    v-else-if="!blobContent"
    :dismissible="false"
    variant="warning"
    data-testid="file-not-found-warning"
  >
    <gl-sprintf :message="$options.i18n.vulnerabilityNotFound">
      <template #file>
        <code>{{ location.file }}</code>
      </template>
      <template #ref>
        <code>{{ ref }}</code>
      </template>
    </gl-sprintf>
  </gl-alert>

  <vulnerability-file-content-viewer
    v-else
    :start-line="startLine"
    :end-line="endLine"
    :is-highlighted="isHighlighted"
    :content="content"
  />
</template>
