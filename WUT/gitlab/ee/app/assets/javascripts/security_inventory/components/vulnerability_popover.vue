<script>
import { GlPopover, GlButton, GlIcon } from '@gitlab/ui';
import { SEVERITY_CLASS_NAME_MAP } from 'ee/vue_shared/security_reports/components/constants';
import { __, s__ } from '~/locale';
import { SEVERITY_LEVELS } from '~/vue_shared/constants';
import timeagoMixin from '~/vue_shared/mixins/timeago';
import { VULNERABILITY_REPORT_PATHS } from '../constants';

export default {
  name: 'VulnerabilityPopover',
  components: {
    GlPopover,
    GlButton,
    GlIcon,
  },
  mixins: [timeagoMixin],
  props: {
    severityCounts: {
      type: Object,
      required: false,
      default: () => ({}),
    },
    webUrl: {
      type: String,
      required: true,
    },
    targetId: {
      type: String,
      required: true,
    },
    isSubGroup: {
      type: Boolean,
      required: false,
      default: false,
    },
  },

  i18n: {
    projectVulnerabilitiesTitle: s__('SecurityInventory|Project vulnerabilities'),
    groupVulnerabilitiesTitle: s__('SecurityInventory|Group vulnerabilities'),
    viewReportButtonText: s__('SecurityInventory|View vulnerability report'),
  },

  computed: {
    popoverTitle() {
      return this.isSubGroup
        ? this.$options.i18n.groupVulnerabilitiesTitle
        : this.$options.i18n.projectVulnerabilitiesTitle;
    },
    vulnerabilityReportPath() {
      const path = this.isSubGroup
        ? VULNERABILITY_REPORT_PATHS.GROUP
        : VULNERABILITY_REPORT_PATHS.PROJECT;
      return `${this.webUrl}${path}`;
    },
    formattedSeverityCounts() {
      const severities = ['critical', 'high', 'medium', 'low', 'info', 'unknown'];

      return severities.map((key) => ({
        label: key,
        value: this.severityCounts?.[key] || 0,
        icon: `severity-${key}`,
        iconColor: SEVERITY_CLASS_NAME_MAP[key],
        severityLabel: SEVERITY_LEVELS[key],
      }));
    },
    formattedDateUpdated() {
      return `${__('Date updated')} ${this.timeFormatted(this.severityCounts?.updatedAt)}`;
    },
  },
};
</script>

<template>
  <gl-popover :title="popoverTitle" :target="targetId" show-close-button>
    <div>
      <ul class="gl-mb-3 gl-grid gl-grid-cols-2 gl-gap-2 gl-pl-0">
        <li
          v-for="item in formattedSeverityCounts"
          :key="item.label"
          class="gl-align-items-center gl-flex gl-items-center gl-gap-2 gl-gap-x-2 gl-pr-10"
          data-testid="severity-item"
        >
          <span>
            <gl-icon
              :name="item.icon"
              :size="12"
              :class="item.iconColor"
              data-testid="severity-icon"
            />
          </span>
          <span class="gl-font-bold" data-testid="severity-label"> {{ item.severityLabel }}: </span>
          <span data-testid="severity-value">{{ item.value }}</span>
        </li>
      </ul>

      <gl-button
        category="secondary"
        variant="confirm"
        class="gl-w-full"
        size="small"
        :href="vulnerabilityReportPath"
      >
        {{ $options.i18n.viewReportButtonText }}
      </gl-button>

      <div
        v-if="severityCounts && severityCounts.updatedAt"
        class="gl-mb-2 gl-mt-3"
        data-testid="date-updated"
      >
        {{ formattedDateUpdated }}
      </div>
    </div>
  </gl-popover>
</template>
