<script>
import { GlLink, GlCard, GlButton, GlIcon, GlCollapse, GlAlert } from '@gitlab/ui';
import SectionLayout from '~/vue_shared/security_configuration/components/section_layout.vue';
import { s__, __ } from '~/locale';
import { createAlert } from '~/alert';
import { helpPagePath } from '~/helpers/help_page_helper';
import axios from '~/lib/utils/axios_utils';
import download from '~/lib/utils/downloader';
import pollUntilComplete from '~/lib/utils/poll_until_complete';
import vulnerabilityArchivesQuery from '../graphql/vulnerability_archives.query.graphql';
import VulnerabilityArchivesTable from './vulnerability_archives_table.vue';

export default {
  i18n: {
    downloadAll: __('Download all'),
    vulnerabilityArchives: s__('SecurityConfiguration|Vulnerability archives'),
    vulnerabilityArchivesDescription: s__(
      'SecurityConfiguration|Vulnerabilities are retained in the database for one year after the last update. After one year of inactivity, vulnerabilities are archived on the first of each month. Archives are removed after five years.',
    ),
    vulnerabilityArchivesDoc: s__(
      'SecurityConfiguration|Learn more about our vulnerability data retention policies',
    ),
    emptyArchive: s__(
      'SecurityConfiguration|This project does not contain any archived vulnerabilities yet.',
    ),
  },
  components: {
    GlIcon,
    GlLink,
    GlCard,
    GlButton,
    GlCollapse,
    SectionLayout,
    VulnerabilityArchivesTable,
    GlAlert,
  },
  inject: ['projectFullPath', 'vulnerabilityArchiveExportPath'],
  data() {
    return {
      expandedYear: 0,
      archive: [],
      preparingExportForPeriod: '',
    };
  },
  apollo: {
    archive: {
      query: vulnerabilityArchivesQuery,
      variables() {
        return {
          fullPath: this.projectFullPath,
        };
      },
      // We receive an array of objects: { archivedRecordsCount: <number>, year: <number>, month: <number> }
      // We map into an array of objects like: { year: <number>, sum: <number>, months: [{ month: <number>, count: <number>} ] }
      update(data) {
        const groupedByYear = data.project.vulnerabilityArchives.reduce((years, archive) => {
          const yearEntry = years[archive.year] || {
            year: archive.year,
            sum: 0,
            months: [],
          };

          yearEntry.months.push({
            month: archive.month - 1,
            count: archive.archivedRecordsCount,
            download: true,
          });

          yearEntry.sum += archive.archivedRecordsCount;
          return { ...years, [archive.year]: yearEntry };
        }, {});

        return Object.values(groupedByYear).sort((a, b) => b.year - a.year);
      },
    },
  },
  computed: {
    hasArchivedData() {
      return this.archive.length > 0;
    },
  },
  methods: {
    formatDateForREST(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
      const year = date.getFullYear();

      return `${day}/${month}/${year}`;
    },
    initiateArchivesExport(year, month) {
      const isMonthProvided = Number.isInteger(month);
      this.preparingExportForPeriod = isMonthProvided ? `${year}-${month}` : `${year}`;

      const startDate = new Date(year, isMonthProvided ? month : 0, 1);
      const endDate = new Date(year, isMonthProvided ? month + 1 : 12, 0); // day 0 => last day of previous month

      axios
        .post(this.vulnerabilityArchiveExportPath, {
          start_date: this.formatDateForREST(startDate),
          end_date: this.formatDateForREST(endDate),
        })
        .then(({ data }) => pollUntilComplete(data._links.self))
        .then(({ data }) => {
          if (data.status !== 'finished') {
            throw new Error();
          }
          download({
            url: data._links.download,
          });
        })
        .catch(() => {
          createAlert({
            message: s__('SecurityReports|There was an error while generating the report.'),
          });
        })
        .finally(() => {
          this.preparingExportForPeriod = '';
        });
    },
    toggleYear(year) {
      this.expandedYear = this.expandedYear === year ? 0 : year;
    },
    isExpanded(item) {
      return this.expandedYear === item.year;
    },
  },
  vulnerabilityArchivalLearnMorePath: helpPagePath(
    'user/application_security/vulnerability_archival/_index.md',
  ),
};
</script>
<template>
  <section-layout :heading="$options.i18n.vulnerabilityArchives">
    <template #description>
      <p>
        {{ $options.i18n.vulnerabilityArchivesDescription }}
      </p>
      <p>
        <gl-link :href="$options.vulnerabilityArchivalLearnMorePath">{{
          $options.i18n.vulnerabilityArchivesDoc
        }}</gl-link>
      </p>
    </template>
    <template #features>
      <ul v-if="hasArchivedData" class="gl-m-0 gl-list-none gl-p-0">
        <li v-for="item in archive" :key="item.year" class="gl-mb-6">
          <gl-card
            :header-class="{ '!gl-border-none gl-rounded-base': !isExpanded(item) }"
            :body-class="{ 'gl-py-0': !isExpanded(item) }"
          >
            <template #header>
              <div class="gl-flex">
                <div class="gl-flex gl-flex-1 gl-items-center">
                  <gl-button class="gl-mr-4" category="tertiary" @click="toggleYear(item.year)">
                    <gl-icon
                      name="chevron-right"
                      class="gl-transition-all"
                      :class="{ 'gl-rotate-90': expandedYear == item.year }"
                    />
                    <strong>{{ item.year }}</strong>
                  </gl-button>
                  <span class="gl-text-secondary">
                    {{
                      n__(
                        'SecurityConfiguration|1 vulnerability',
                        'SecurityConfiguration|%d vulnerabilities',
                        item.sum,
                      )
                    }}
                  </span>
                </div>
                <gl-button
                  :loading="preparingExportForPeriod === `${item.year}`"
                  :data-testid="`${item.year}-download-all`"
                  @click="initiateArchivesExport(item.year)"
                  >{{ $options.i18n.downloadAll }}</gl-button
                >
              </div>
            </template>

            <gl-collapse :visible="isExpanded(item)">
              <vulnerability-archives-table
                :items="item.months"
                :year="item.year"
                :preparing-export-for-period="preparingExportForPeriod"
                @download="initiateArchivesExport(item.year, $event)"
              />
            </gl-collapse>
          </gl-card>
        </li>
      </ul>
      <gl-alert v-else :dismissable="false" variant="tip">
        {{ $options.i18n.emptyArchive }}
      </gl-alert>
    </template>
  </section-layout>
</template>
