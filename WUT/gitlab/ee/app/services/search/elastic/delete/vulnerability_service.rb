# frozen_string_literal: true

module Search
  module Elastic
    module Delete
      # Deletes vulnerability documents for a project with traversal_ids other than the specified one.
      # Used when removing documents with old routing_id during project transfers.
      class VulnerabilityService < BaseService
        private

        def index_name
          ::Search::Elastic::Types::Vulnerability.index_name
        end

        def build_query
          project_id = options[:project_id]
          traversal_id = options[:traversal_id]
          if project_id.nil? || traversal_id.nil?
            Gitlab::ErrorTracking.track_and_raise_for_dev_exception(
              ArgumentError.new('project_id and traversal_id are required')
            )
            return
          end

          {
            query: {
              bool: {
                filter: [
                  { term: { project_id: project_id } },
                  { bool: { must_not: { prefix: { traversal_ids: { value: traversal_id } } } } }
                ]
              }
            }
          }
        end
      end
    end
  end
end
