version: "2"

services:
  dbproxy:
    image: python:3.10-slim
    container_name: proxy_python_app
    volumes:
      - ../../shared-data:/shared-data
      - ../proxy:/proxy
    command: python /proxy/sql_proxy.py
    environment:
      - PYTHONUNBUFFERED=1
      - WUT_NAME=${WUT_NAME}
      - DB_CONTAINER_NAME=db
    depends_on:
      - db

  phpmyadmin:
    image: phpmyadmin:5.2.1
    ports:
      - "8801:80"
    links:
      - db:db

  server:
    # image: docker.gitea.com/gitea:1.24.5-rootless
    # environment:
    #   - GITEA__database__DB_TYPE=mysql
    #   - GITEA__database__HOST=db:3306
    #   - GITEA__database__NAME=gitea
    #   - GITEA__database__USER=gitea
    #   - GITEA__database__PASSWD=gitea
    build:
      context: .
      dockerfile_inline: |
        FROM docker.gitea.com/gitea:1.24.5-rootless
        COPY ./_resources/app.ini /etc/gitea/app.ini
    restart: always
    volumes:
      # - data:/var/lib/gitea
      # - config:/etc/gitea
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "8081:3000"
      - "2222:2222"
    depends_on:
      - db

  db:
    build:
      context: .
      dockerfile_inline: |
        FROM mysql:8.4.0
        COPY ./_resources/db.sql /docker-entrypoint-initdb.d/db.sql
    command: mysqld
    environment:
      MYSQL_DATABASE: gitea
      MYSQL_USER: gitea
      MYSQL_PASSWORD: gitea
      MYSQL_ROOT_PASSWORD: gitea
      MYSQL_ROOT_HOST: "%"
      MYSQL_USER_HOST: "%"

  # db:
  #   image: docker.io/library/mysql:8
  #   restart: always
  #   environment:
  #     - MYSQL_ROOT_PASSWORD=gitea
  #     - MYSQL_USER=gitea
  #     - MYSQL_PASSWORD=gitea
  #     - MYSQL_DATABASE=gitea